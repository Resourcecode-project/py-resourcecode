image: python


include:
  - project: "open-source/gitlab-templates"
    ref: "branch/default"
    file:
      - "templates/no-duplicate-pipelines.yml"
      - "templates/release-on-heptapod.yml"

stages:
  - lint
  - test
  - build-push
  - release

check-manifest:
  stage: lint
  before_script:
    - pip install tox
  script: tox -e check-manifest

flake8:
  stage: lint
  before_script:
    - pip install tox
  script: tox -e flake8


black:
  stage: lint
  before_script:
    - pip install tox
  script: tox -e black

tests:
  stage: test
  before_script:
    - pip install tox
  script: tox -e py3

build-push-devpi:
  stage: build-push
  only:
    - branch/default
  script:
    - pip install devpi-client
    - devpi use $DEVPI_URL
    - devpi login $DEVPI_LOGIN --password $DEVPI_PWD
    - devpi use dev
    - devpi upload
